<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ°´æºç›£æ¸¬ Pro - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background: #f4f7f9; padding: 20px; text-align: center; }
        .container { max-width: 650px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card { background: #fff; border: 1px solid #f0f0f0; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: left; }
        .title { font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #1a73e8; padding-bottom: 5px; }
        .data-display { display: flex; justify-content: space-around; text-align: center; }
        .num { font-size: 36px; font-weight: bold; color: #1a73e8; }
        .unit { font-size: 18px; color: #333; font-weight: bold; margin-left: 5px; }
        #diag-box { padding: 25px; border-radius: 10px; background: #eee; font-weight: bold; font-size: 22px; border: 2px solid #ccc; margin-top: 10px; }
        .status-bar { font-size: 12px; color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸŒŠ æ°´æºç›£æ¸¬ Pro</h2>
    <div id="status-text" class="status-bar">æ­£åœ¨é€£æ¥ç³»çµ±...</div>

    <div class="card">
        <div class="title">ğŸ“Š å³æ™‚é‡æ¸¬å€¼</div>
        <div class="data-display">
            <div>
                <div style="color:#888;">ç›®å‰æ°´ä½</div>
                <span id="w-num" class="num">--</span><span class="unit">cm</span>
            </div>
            <div>
                <div style="color:#888;">ç†è«–æµé€Ÿ</div>
                <span id="f-num" class="num">--</span><span class="unit">cm/min</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="title">âš™ï¸ åˆ¤å®šé‚è¼¯è¨­å®š</div>
        <div style="font-size:14px; line-height:2;">
            <div>ç¸½é«˜è¨­å®šå€¼ï¼š<b>80 cm</b></div>
            <div style="color:orange;">å µå¡è­¦ç¤ºï¼šæµé€Ÿ < 4800 ä¸” æ°´ä½ â‰¥ 26.6cm</div>
            <div style="color:red;">æ¹æ€¥è­¦ç¤ºï¼šæµé€Ÿ > 18000</div>
        </div>
    </div>

    <div id="diag-box">ğŸ® ç³»çµ±æœªé€£ç·š</div>
</div>

<script>
    const mqtt_broker = "broker.emqx.io";
    const mqtt_port = 8084;
    const mqtt_topic = "my_ditch_project/data";
    const client_id = "Web_" + Math.random().toString(16).substr(2, 8);
    
    const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, client_id);
    let watchDog;

    client.connect({
        useSSL: true,
        onSuccess: () => {
            document.getElementById("status-text").innerText = "â— ç³»çµ±å·²é€£ç·š";
            client.subscribe(mqtt_topic);
        },
        onFailure: () => { document.getElementById("status-text").innerText = "â— é€£ç·šå¤±æ•—"; }
    });

    client.onMessageArrived = (message) => {
        clearTimeout(watchDog);
        try {
            const data = JSON.parse(message.payloadString);
            const h = data.level;
            const f = data.flow;

            // æ›´æ–°æ•¸å­— (å–®ä½ cm å’Œ cm/min å·²åœ¨ HTML å¯«æ­»ï¼Œä¸æœƒè¢«è¦†è“‹)
            document.getElementById("w-num").innerText = h.toFixed(1);
            document.getElementById("f-num").innerText = f;

            const box = document.getElementById("diag-box");
            if (h >= 26.6 && f < 4800) {
                box.innerText = "âŒ åµæ¸¬åˆ°ç®¡è·¯å µå¡";
                box.style.color = "orange"; box.style.background = "#fff3e0"; box.style.borderColor = "orange";
            } else if (f > 18000) {
                box.innerText = "âš ï¸ åµæ¸¬åˆ°æ°´æµæ¹æ€¥";
                box.style.color = "red"; box.style.background = "#ffebee"; box.style.borderColor = "red";
            } else {
                box.innerText = "âœ… ç³»çµ±æ­£å¸¸ç„¡ç•°å¸¸";
                box.style.color = "green"; box.style.background = "#e8f5e9"; box.style.borderColor = "green";
            }
        } catch (e) { console.error("è§£æå¤±æ•—", e); }

        watchDog = setTimeout(() => {
            document.getElementById("diag-box").innerText = "ğŸ® ç³»çµ±æ²’é€£åˆ°";
            document.getElementById("diag-box").style.background = "#eee";
        }, 5000);
    };

    client.onConnectionLost = () => { document.getElementById("status-text").innerText = "â— é€£ç·šå·²ä¸­æ–·"; };
</script>
</body>
</html>
