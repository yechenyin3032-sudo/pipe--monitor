<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æºæµé‡ç›£æ¸¬ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; text-align: center; padding: 20px; }
        .dashboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 200px; }
        .card h3 { color: #555; margin-bottom: 10px; }
        .value { font-size: 2.5em; font-weight: bold; color: #2c3e50; }
        .unit { font-size: 1em; color: #888; }
        #status { margin-top: 20px; color: #666; font-size: 0.9em; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #2ecc71; }
    </style>
</head>
<body>

    <h1>ğŸŒŠ æ°´æºæµé‡å³æ™‚ç›£æ¸¬</h1>

    <div class="dashboard">
        <div class="card">
            <h3>ç›®å‰æ°´ä½ (Level)</h3>
            <div id="level-val" class="value">--</div>
            <div class="unit">cm</div>
        </div>
        <div class="card">
            <h3>ä¼°ç®—æµé€Ÿ (Flow)</h3>
            <div id="flow-val" class="value">--</div>
            <div class="unit">m/s</div>
        </div>
        <div class="card">
            <h3>æ„Ÿæ¸¬è·é›¢ (Raw)</h3>
            <div id="dist-val" class="value">--</div>
            <div class="unit">cm</div>
        </div>
    </div>

    <div id="status">
        <span id="status-dot" class="status-dot"></span>
        <span id="status-text">æ­£åœ¨é€£æ¥ MQTT Broker...</span>
    </div>

    <script>
        // --- è¨­å®šå€ (å¿…é ˆèˆ‡ ESP32 ä¸€è‡´) ---
        const mqtt_broker = "broker.emqx.io";
        const mqtt_port = 8084; // 8084 æ˜¯ EMQX çš„ WSS (SSL) ç«¯å£
        const mqtt_topic = "my_ditch_project/data"; 
        // --------------------------------

        // ç”¢ç”Ÿéš¨æ©Ÿ Client ID
        const client_id = "Web_Client_" + Math.random().toString(16).substr(2, 8);
        const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, client_id);

        // è¨­å®šå›èª¿å‡½æ•¸
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // é€£æ¥é¸é …
        const options = {
            useSSL: true, // GitHub Pages å¼·åˆ¶ HTTPSï¼Œæ‰€ä»¥å¿…é ˆç”¨ SSL
            onSuccess: onConnect,
            onFailure: onFailure,
            keepAliveInterval: 30
        };

        // é–‹å§‹é€£æ¥
        client.connect(options);

        function onConnect() {
            console.log("Connected to Broker");
            document.getElementById("status-text").innerText = "å·²é€£ç·šæ¥æ”¶æ•¸æ“šä¸­";
            document.getElementById("status-dot").classList.add("connected");
            
            // è¨‚é–±ä¸»é¡Œ
            client.subscribe(mqtt_topic);
        }

        function onFailure(responseObject) {
            console.log("Connection Failed: " + responseObject.errorMessage);
            document.getElementById("status-text").innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†";
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
                document.getElementById("status-dot").classList.remove("connected");
                document.getElementById("status-text").innerText = "é€£ç·šä¸­æ–·";
            }
        }

        function onMessageArrived(message) {
            console.log("Data Received: " + message.payloadString);
            try {
                // è§£æ JSON
                const data = JSON.parse(message.payloadString);
                
                // æ›´æ–°ç•«é¢
                document.getElementById("dist-val").innerText = data.distance.toFixed(1);
                document.getElementById("level-val").innerText = data.level.toFixed(1);
                document.getElementById("flow-val").innerText = data.flow.toFixed(1);
                
            } catch (e) {
                console.error("JSON Parse Error", e);
            }
        }
    </script>
</body>
</html>
