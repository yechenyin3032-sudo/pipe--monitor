<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŠ ç®¡è·¯ç›£æ¸¬ç³»çµ± Pro (MQTT é›²ç«¯ç‰ˆ)</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; font-size: 24px; }
        .data-box { display: flex; justify-content: space-around; margin: 25px 0; }
        .card { flex: 1; margin: 10px; padding: 20px; background: #f8f9fa; border-radius: 15px; border-top: 5px solid #1a73e8; }
        .value { font-size: 32px; font-weight: bold; color: #202124; display: block; }
        .label { color: #5f6368; font-size: 14px; }
        #status-indicator { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; background: #fee; color: #d93025; transition: 0.3s; }
        .diagnosis { margin-top: 20px; padding: 15px; border-radius: 10px; background: #e8f0fe; color: #1967d2; font-weight: bold; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸŒŠ ç®¡è·¯ç›£æ¸¬ç³»çµ± Pro</h1>
    <div id="status-indicator">â— é›²ç«¯å˜—è©¦é€£ç·šä¸­...</div>
    
    <div class="data-box">
        <div class="card">
            <span class="label">ç›®å‰æ°´ä½</span>
            <span id="water-level-val" class="value">--</span>
            <span class="label">cm</span>
        </div>
        <div class="card">
            <span class="label">é ä¼°æµé€Ÿ</span>
            <span id="flow-rate-val" class="value">0.00</span>
            <span class="label">m/s</span>
        </div>
    </div>

    <div class="diagnosis">
        ç³»çµ±è¨ºæ–·çµæœï¼š<span id="diag-result">ç­‰å¾…æ•¸æ“šä¸­...</span>
    </div>
    
    <hr>
    <div style="font-size: 12px; color: #999;">
        é€£ç·šæ–¹å¼ï¼šMQTT Broker (HiveMQ)<br>
        ç›£è½é »é“ï¼šyechenyin3032/water_data
    </div>
</div>

<script>
    // 2. è¨­å®š MQTT åƒæ•¸ (å¿…é ˆèˆ‡ ESP32 çš„ Topic ä¸€è‡´)
    const mqttServer = 'ws://broker.hivemq.com:8000/mqtt'; 
    const topic = 'yechenyin3032/water_data';

    // 3. é–‹å§‹é€£ç·š
    const client = mqtt.connect(mqttServer);

    client.on('connect', () => {
        console.log("âœ… æˆåŠŸé€£ç·šåˆ° MQTT ä¼ºæœå™¨");
        client.subscribe(topic);
        const indicator = document.getElementById("status-indicator");
        indicator.innerText = "â— é›²ç«¯åŒæ­¥ä¸­ (ä¸é™ç¶²åŸŸ)";
        indicator.style.background = "#e6f4ea";
        indicator.style.color = "#137333";
    });

    client.on('message', (t, message) => {
        try {
            // 4. è§£æä¾†è‡ª ESP32 çš„ JSON æ•¸æ“š
            const data = JSON.parse(message.toString());
            console.log("æ”¶åˆ°æ•¸æ“š:", data);

            // æ›´æ–°ç¶²é é¡¯ç¤º
            document.getElementById("water-level-val").innerText = data.level;
            document.getElementById("diag-result").innerText = data.msg;
            
            // å¦‚æœæ°´ä½é«˜æ–¼ 26.6cmï¼Œè¨ºæ–·çµæœè®Šç´…
            const diagBox = document.getElementById("diag-result");
            if (parseFloat(data.level) >= 26.6) {
                diagBox.style.color = "#d93025";
            } else {
                diagBox.style.color = "#1967d2";
            }

        } catch (e) {
            console.error("è§£æå¤±æ•—:", e);
        }
    });

    client.on('error', (err) => {
        console.error("MQTT é€£ç·šéŒ¯èª¤:", err);
        document.getElementById("status-indicator").innerText = "â— é€£ç·šå¤±æ•—";
    });
</script>

</body>
</html>
