<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ°´æµç›£æ¸¬ Pro</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body { font-family: Arial; background:#f4f7f9; padding:20px; }
.card { background:white; padding:20px; margin-bottom:20px; border-radius:10px; }
.num { font-size:40px; font-weight:bold; }
#diag-box { padding:20px; font-size:22px; text-align:center; border-radius:10px; }
</style>
</head>

<body>

<h2>ğŸŒŠ æ°´æµç›£æ¸¬ç³»çµ±</h2>

<div class="card">
  <div>æ°´ä½é«˜åº¦</div>
  <span id="w-val" class="num">--</span> cm
</div>

<div class="card">
  <div>ç†è«–æµé€Ÿ</div>
  <span id="f-val" class="num">--</span> cm/min
</div>

<div class="card">
  <div id="diag-box">ğŸ”´ å°šæœªæ¥æ”¶åˆ°è³‡æ–™</div>
</div>

<script>
const n = 0.03;
const S = 0.001;

// âš ï¸ é—œéµåœ¨é€™ä¸€è¡Œ
const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

let watchDog;

client.on('connect', () => {
  console.log("âœ… Web MQTT å·²é€£ç·š");
  client.subscribe('yechenyin3032/water_data');
});

client.on('message', (topic, msg) => {
  clearTimeout(watchDog);

  const h_cm = parseFloat(msg.toString());
  if (isNaN(h_cm)) return;

  const h_m = h_cm / 100;
  let v_cm_min = 0;

  if (h_m > 0) {
    const Rh = h_m * 0.5;
    const v_m_s = (1 / n) * Math.pow(Rh, 2/3) * Math.sqrt(S);
    v_cm_min = Math.round(v_m_s * 100 * 60);
  }

  document.getElementById("w-val").innerText = h_cm.toFixed(1);
  document.getElementById("f-val").innerText = v_cm_min;

  const box = document.getElementById("diag-box");

  if (h_cm >= 26.6 && v_cm_min < 4800) {
    box.innerText = "âŒ å¯èƒ½å µå¡";
    box.style.color = "orange";
  } else if (v_cm_min > 18000) {
    box.innerText = "âš ï¸ æ°´æµéå¿«";
    box.style.color = "red";
  } else {
    box.innerText = "âœ… ç³»çµ±æ­£å¸¸";
    box.style.color = "green";
  }

  watchDog = setTimeout(() => {
    box.innerText = "ğŸ”´ è³‡æ–™ä¸­æ–·";
    box.style.color = "#999";
  }, 5000);
});
</script>

</body>
</html>
